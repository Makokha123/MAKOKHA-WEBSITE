<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Communication - Makokha Medical Centre</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f0f2f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .communication-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            background: #075e54;
            color: white;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-header p {
            opacity: 0.8;
            margin-bottom: 1rem;
        }

        .refresh-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .refresh-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .appointment-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .appointment-item {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #e0e0e0;
        }

        .appointment-item:hover {
            background: #f5f5f5;
        }

        .appointment-item.active {
            background: #e3f2fd;
            border-color: #075e54;
        }

        .appointment-info h3 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .appointment-info p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .appointment-status, .payment-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-scheduled {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .payment-pending {
            background: #fff3cd;
            color: #856404;
        }

        .payment-completed {
            background: #d4edda;
            color: #155724;
        }

        .unread-badge {
            background: #dc3545;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .loading-state, .empty-state {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #075e54;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Chat Area Styles */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .chat-header {
            background: white;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #075e54;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .contact-details h2 {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .contact-details p {
            color: #666;
            font-size: 0.9rem;
        }

        .call-controls {
            display: flex;
            gap: 0.5rem;
        }

        .call-btn {
            background: #075e54;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .call-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .call-btn:hover:not(:disabled) {
            background: #064e45;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f5f5f5;
        }

        .message {
            max-width: 70%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            position: relative;
        }

        .message.sent {
            background: #dcf8c6;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            background: white;
            border-bottom-left-radius: 4px;
        }

        .message-text {
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .message-time {
            font-size: 0.75rem;
            color: #999;
            text-align: right;
        }

        .message-status {
            font-size: 0.7rem;
            color: #999;
            position: absolute;
            bottom: 0.5rem;
            right: 1rem;
        }

        /* Audio Message Styles */
        .audio-message {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .audio-player {
            flex: 1;
            height: 40px;
        }

        .audio-duration {
            font-size: 0.8rem;
            color: #666;
        }

        /* Voice Recorder */
        .voice-recorder {
            background: white;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e0e0e0;
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .record-btn {
            background: #dc3545;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .record-btn.recording {
            background: #28a745;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .recording-timer {
            font-weight: 600;
            color: #dc3545;
        }

        .recording-controls {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .control-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .send-recording {
            background: #28a745;
            color: white;
        }

        .send-recording:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .cancel-recording {
            background: #f5f5f5;
            color: #333;
        }

        /* Input Area */
        .input-area {
            background: white;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .input-tools {
            display: flex;
            gap: 0.5rem;
        }

        .tool-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .tool-btn:hover {
            background: #f0f0f0;
        }

        .tool-btn:disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .tool-btn:disabled:hover {
            background: none;
        }

        .message-input {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            padding: 0.75rem 1rem;
            resize: none;
            font-family: inherit;
            font-size: 1rem;
            max-height: 120px;
            outline: none;
        }

        .message-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .send-btn {
            background: #075e54;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .send-btn:hover:not(:disabled) {
            background: #064e45;
        }

        /* Typing Indicator */
        .typing-indicator {
            padding: 0.5rem 1.5rem;
            color: #666;
            font-size: 0.9rem;
            display: none;
        }

        .typing-indicator.visible {
            display: block;
        }

        .typing-dots {
            display: inline-flex;
            gap: 0.25rem;
            margin-right: 0.5rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Voice Call Interface */
        .voice-call-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #075e54, #128c7e);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .voice-call-interface .caller-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin-bottom: 2rem;
        }

        .voice-call-interface .call-status {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .voice-call-interface .call-duration {
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }

        .voice-call-interface .call-controls {
            display: flex;
            gap: 1rem;
        }

        .voice-call-interface .call-control-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s;
        }

        .voice-call-interface .mute-btn {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .voice-call-interface .mute-btn.muted {
            background: #f44336;
        }

        .voice-call-interface .end-call-btn {
            background: #f44336;
            color: white;
        }

        /* Video Call Interface */
        .video-call-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .video-call-header {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .caller-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .caller-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #075e54;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .caller-details h3 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .call-status {
            font-size: 0.9rem;
            color: #ccc;
        }

        .call-duration {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Video Container */
        .video-container {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .video-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            padding: 10px;
            align-items: center;
            justify-items: center;
        }

        .video-participant {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
            height: 100%;
            max-height: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .video-participant video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .participant-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .participant-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
        }

        .participant-status.muted {
            background: #f44336;
        }

        /* Video Controls */
        .video-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            z-index: 3;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .control-btn.mute-btn {
            background: #666;
            color: white;
        }

        .control-btn.mute-btn.muted {
            background: #f44336;
        }

        .control-btn.video-btn {
            background: #666;
            color: white;
        }

        .control-btn.video-btn.off {
            background: #f44336;
        }

        .control-btn.screen-share-btn {
            background: #666;
            color: white;
        }

        .control-btn.screen-share-btn.active {
            background: #4caf50;
        }

        .control-btn.record-btn {
            background: #666;
            color: white;
        }

        .control-btn.record-btn.recording {
            background: #f44336;
            animation: pulse 1.5s infinite;
        }

        .control-btn.settings-btn {
            background: #666;
            color: white;
        }

        .control-btn.end-call-btn {
            background: #f44336;
            color: white;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        /* Device Permission Modal */
        .device-permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            display: none;
        }

        .device-permission-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .device-permission-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .device-permission-header h2 {
            color: #075e54;
            margin-bottom: 0.5rem;
        }

        .device-permission-header p {
            color: #666;
        }

        .device-selection {
            margin-bottom: 1.5rem;
        }

        .device-group {
            margin-bottom: 1rem;
        }

        .device-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .device-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
        }

        .device-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .device-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .confirm-devices-btn {
            background: #075e54;
            color: white;
        }

        .confirm-devices-btn:hover {
            background: #064e45;
        }

        .cancel-devices-btn {
            background: #f5f5f5;
            color: #333;
        }

        .cancel-devices-btn:hover {
            background: #e0e0e0;
        }

        /* Device Settings Panel */
        .device-settings-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            border-radius: 8px;
            z-index: 100;
            display: none;
            min-width: 250px;
        }

        .device-settings-header {
            color: white;
            margin-bottom: 1rem;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-settings-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .device-settings-group {
            margin-bottom: 1rem;
        }

        .device-settings-group label {
            display: block;
            color: white;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .device-settings-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #666;
            border-radius: 4px;
            background: #333;
            color: white;
            font-size: 0.8rem;
        }

        .device-test-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .test-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            flex: 1;
        }

        .test-audio-btn {
            background: #4caf50;
            color: white;
        }

        .test-video-btn {
            background: #2196f3;
            color: white;
        }

        /* Connection Status */
        .connection-status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 5;
            display: none;
        }

        .connection-status.connected {
            background: rgba(76, 175, 80, 0.8);
        }

        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.8);
        }

        /* Incoming Call Notification */
        .incoming-call-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            width: 90%;
            max-width: 400px;
        }

        .notification-content {
            padding: 2rem;
            text-align: center;
        }

        .incoming-call-notification .caller-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #075e54;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin: 0 auto 1rem;
        }

        .incoming-call-notification .caller-avatar.ringing {
            animation: ring 1s infinite;
        }

        @keyframes ring {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .incoming-call-notification h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        .incoming-call-notification p {
            color: #666;
            margin-bottom: 1.5rem;
        }

        .call-actions, .timeout-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .accept-call-btn, .retry-call-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .reject-call-btn, .cancel-call-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .communication-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40%;
            }
            
            .chat-area {
                height: 60%;
            }
            
            .message {
                max-width: 85%;
            }
            
            .video-grid {
                grid-template-columns: 1fr;
            }
            
            .video-participant {
                max-height: 300px;
            }
            
            .video-controls {
                bottom: 10px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .device-settings-panel {
                top: 60px;
                right: 10px;
                min-width: 200px;
            }
        }

        /* Toggle Sidebar Button */
        .toggle-sidebar {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #075e54;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            z-index: 20;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .toggle-sidebar {
                display: flex;
            }
            
            .sidebar {
                position: fixed;
                left: -100%;
                width: 85%;
                height: 100%;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Toggle Sidebar Button (Mobile) -->
    <button class="toggle-sidebar" id="toggleSidebar">
        <i class="fas fa-bars"></i>
    </button>

    <div class="communication-container">
        <!-- Sidebar with Appointments -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>Medical Consultations</h1>
                <p>Select an appointment to communicate</p>
                <button class="refresh-button" onclick="loadAppointments()" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="appointment-list" id="appointmentList">
                <!-- Loading state -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <p>Loading appointments...</p>
                </div>
                
                <!-- Empty state (initially hidden) -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">💬</div>
                    <h3>No appointments found</h3>
                    <p>You don't have any appointments yet. Book an appointment to start communicating with doctors.</p>
                </div>
                
                <!-- Appointments will be loaded here dynamically -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-area">
            <!-- Device Permission Modal -->
            <div class="device-permission-modal" id="devicePermissionModal">
                <div class="device-permission-content">
                    <div class="device-permission-header">
                        <h2>Device Permissions Required</h2>
                        <p>Please allow access to your camera, microphone, and speakers for video calls</p>
                    </div>
                    
                    <div class="device-selection">
                        <div class="device-group">
                            <label for="cameraSelect">Camera:</label>
                            <select id="cameraSelect" class="device-select">
                                <option value="">Loading cameras...</option>
                            </select>
                        </div>
                        
                        <div class="device-group">
                            <label for="microphoneSelect">Microphone:</label>
                            <select id="microphoneSelect" class="device-select">
                                <option value="">Loading microphones...</option>
                            </select>
                        </div>
                        
                        <div class="device-group">
                            <label for="speakerSelect">Speaker:</label>
                            <select id="speakerSelect" class="device-select">
                                <option value="">Loading speakers...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="device-actions">
                        <button class="device-btn cancel-devices-btn" id="cancelDevicesBtn">Cancel</button>
                        <button class="device-btn confirm-devices-btn" id="confirmDevicesBtn">Confirm Devices</button>
                    </div>
                </div>
            </div>

            <!-- Incoming Call Notification -->
            <div class="incoming-call-notification" id="incomingCallNotification">
                <div class="notification-content">
                    <div class="caller-avatar" id="incomingCallAvatar">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div class="caller-info">
                        <h3 id="incomingCallName">Incoming Call</h3>
                        <p id="incomingCallType">Video Call</p>
                    </div>
                    <div class="call-actions">
                        <button class="accept-call-btn" id="acceptCallBtn">
                            <i class="fas fa-phone"></i> Accept
                        </button>
                        <button class="reject-call-btn" id="rejectCallBtn">
                            <i class="fas fa-phone-slash"></i> Decline
                        </button>
                    </div>
                </div>
            </div>

            <div class="chat-header">
                <div class="contact-info">
                    <div class="contact-avatar" id="contactAvatar">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div class="contact-details">
                        <h2 id="contactName">Medical Consultation Hub</h2>
                        <p id="contactStatus">Select an appointment to start messaging</p>
                    </div>
                </div>
                <div class="call-controls">
                    <button class="call-btn" id="voiceCallBtn" disabled>
                        <i class="fas fa-phone"></i> Voice Call
                    </button>
                    <button class="call-btn" id="videoCallBtn" disabled>
                        <i class="fas fa-video"></i> Video Call
                    </button>
                    <button class="call-btn recording" id="startRecordingBtn" disabled>
                        <i class="fas fa-microphone"></i> Record
                    </button>
                </div>
            </div>

            <!-- Voice Recorder -->
            <div class="voice-recorder" id="voiceRecorder">
                <button class="record-btn" id="recordBtn">
                    <i class="fas fa-circle"></i>
                </button>
                <div class="recording-timer" id="recordingTimerDisplay">00:00</div>
                <div class="recording-controls">
                    <button class="control-btn send-recording" id="sendRecordingBtn" disabled>
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                    <button class="control-btn cancel-recording" id="cancelRecordingBtn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>

            <!-- Voice Call Interface -->
            <div class="voice-call-interface" id="voiceCallInterface">
                <div class="caller-avatar" id="callerAvatar">
                    <i class="fas fa-user-md"></i>
                </div>
                <div class="call-status" id="callStatus">Calling...</div>
                <div class="call-duration" id="callDuration">00:00</div>
                <div class="call-controls">
                    <button class="call-control-btn mute-btn" id="callMuteBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="call-control-btn end-call-btn" id="endCallBtn">
                        <i class="fas fa-phone"></i>
                    </button>
                </div>
            </div>

            <!-- Video Call Interface -->
            <div class="video-call-interface" id="videoCallInterface">
                <div class="video-call-header">
                    <div class="caller-info">
                        <div class="caller-avatar" id="videoCallerAvatar">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div class="caller-details">
                            <h3 id="videoCallerName">Dr. Jane Smith</h3>
                            <div class="call-status" id="videoCallStatus">Connecting...</div>
                        </div>
                    </div>
                    <div class="call-duration" id="videoCallDuration">00:00</div>
                    <div class="header-controls">
                        <button class="header-btn" id="participantsBtn" title="Participants">
                            <i class="fas fa-users"></i>
                        </button>
                        <button class="header-btn" id="chatBtn" title="Chat">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button class="header-btn" id="deviceSettingsBtn" title="Settings">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Connection Status -->
                <div class="connection-status" id="connectionStatus">Connecting...</div>
                
                <!-- Device Settings Panel -->
                <div class="device-settings-panel" id="deviceSettingsPanel">
                    <div class="device-settings-header">
                        <span>Device Settings</span>
                        <button class="close-settings-btn" id="closeSettingsBtn">×</button>
                    </div>
                    
                    <div class="device-settings-group">
                        <label for="cameraSettingsSelect">Camera:</label>
                        <select id="cameraSettingsSelect" class="device-settings-select">
                            <option value="">Loading cameras...</option>
                        </select>
                    </div>
                    
                    <div class="device-settings-group">
                        <label for="microphoneSettingsSelect">Microphone:</label>
                        <select id="microphoneSettingsSelect" class="device-settings-select">
                            <option value="">Loading microphones...</option>
                        </select>
                    </div>
                    
                    <div class="device-settings-group">
                        <label for="speakerSettingsSelect">Speaker:</label>
                        <select id="speakerSettingsSelect" class="device-settings-select">
                            <option value="">Loading speakers...</option>
                        </select>
                    </div>
                    
                    <div class="device-test-buttons">
                        <button class="test-btn test-audio-btn" id="testAudioBtn">Test Audio</button>
                        <button class="test-btn test-video-btn" id="testVideoBtn">Test Video</button>
                    </div>
                </div>
                
                <div class="video-container">
                    <div class="video-grid" id="videoGrid">
                        <!-- Video participants will be added here dynamically -->
                        <div class="video-participant" id="localParticipant">
                            <video id="localVideo" autoplay muted playsinline></video>
                            <div class="participant-info">
                                <div class="participant-status"></div>
                                <span>You</span>
                            </div>
                        </div>
                        <div class="video-participant" id="remoteParticipant">
                            <video id="remoteVideo" autoplay playsinline></video>
                            <div class="participant-info">
                                <div class="participant-status"></div>
                                <span>Remote User</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="video-controls">
                    <button class="control-btn mute-btn" id="videoMuteBtn" title="Mute">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="control-btn video-btn" id="videoToggleBtn" title="Turn off video">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="control-btn screen-share-btn" id="screenShareBtn" title="Share screen">
                        <i class="fas fa-desktop"></i>
                    </button>
                    <button class="control-btn record-btn" id="recordBtn" title="Record">
                        <i class="fas fa-circle"></i>
                    </button>
                    <button class="control-btn settings-btn" id="videoSettingsBtn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="control-btn end-call-btn" id="videoEndCallBtn" title="End call">
                        <i class="fas fa-phone"></i>
                    </button>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <div class="message received">
                    <div class="message-text">
                        Welcome to your medical consultation chat! Select an appointment to start communicating with your healthcare provider.
                    </div>
                    <div class="message-time" id="welcomeTime"></div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <span class="typing-dots">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </span>
                <span id="typingUserName">Someone</span> is typing...
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-tools">
                    <button class="tool-btn" title="Emoji" id="emojiBtn">
                        <i class="far fa-smile"></i>
                    </button>
                    <button class="tool-btn" title="Attach File" id="attachBtn">
                        <i class="fas fa-paperclip"></i>
                    </button>
                </div>
                <textarea class="message-input" id="messageInput" placeholder="Type a message..." disabled></textarea>
                <button class="send-btn" id="sendBtn" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" style="display: none;" accept="*/*">

    <script>
        // ==================== MEDICAL COMMUNICATION SYSTEM ====================
        (function() {
            'use strict';

            // Global variables
            let currentAppointment = null;
            let isInCall = false;
            let localStream = null;
            let remoteStream = null;
            let peerConnection = null;
            let isVideoCall = false;
            let callTimer = null;
            let callSeconds = 0;
            let isScreenSharing = false;
            let isRecording = false;
            let mediaRecorder = null;
            let recordedChunks = [];
            let socket = null;
            let isSocketConnected = false;
            let typingTimeout = null;
            let voiceMediaRecorder = null;
            let voiceAudioChunks = [];
            let voiceRecordingTimer = null;
            let voiceRecordingSeconds = 0;
            let isVoiceRecording = false;

            // Device management variables
            let availableCameras = [];
            let availableMicrophones = [];
            let availableSpeakers = [];
            let selectedCameraId = '';
            let selectedMicrophoneId = '';
            let selectedSpeakerId = '';
            let isFirstTimeUser = true;
            let devicePermissionsGranted = false;

            // WebRTC configuration
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ],
                iceCandidatePoolSize: 10
            };

            // DOM Elements
            const sidebar = document.getElementById('sidebar');
            const toggleSidebar = document.getElementById('toggleSidebar');
            const appointmentList = document.getElementById('appointmentList');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const contactAvatar = document.getElementById('contactAvatar');
            const contactName = document.getElementById('contactName');
            const contactStatus = document.getElementById('contactStatus');
            const messagesContainer = document.getElementById('messagesContainer');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const voiceCallBtn = document.getElementById('voiceCallBtn');
            const videoCallBtn = document.getElementById('videoCallBtn');
            const startRecordingBtn = document.getElementById('startRecordingBtn');
            const voiceRecorder = document.getElementById('voiceRecorder');
            const recordBtn = document.getElementById('recordBtn');
            const recordingTimerDisplay = document.getElementById('recordingTimerDisplay');
            const sendRecordingBtn = document.getElementById('sendRecordingBtn');
            const cancelRecordingBtn = document.getElementById('cancelRecordingBtn');
            const voiceCallInterface = document.getElementById('voiceCallInterface');
            const callStatus = document.getElementById('callStatus');
            const callDuration = document.getElementById('callDuration');
            const callMuteBtn = document.getElementById('callMuteBtn');
            const endCallBtn = document.getElementById('endCallBtn');
            const videoCallInterface = document.getElementById('videoCallInterface');
            const videoCallerName = document.getElementById('videoCallerName');
            const videoCallStatus = document.getElementById('videoCallStatus');
            const videoCallDuration = document.getElementById('videoCallDuration');
            const videoGrid = document.getElementById('videoGrid');
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            const videoMuteBtn = document.getElementById('videoMuteBtn');
            const videoToggleBtn = document.getElementById('videoToggleBtn');
            const screenShareBtn = document.getElementById('screenShareBtn');
            const videoRecordBtn = document.getElementById('recordBtn');
            const videoSettingsBtn = document.getElementById('videoSettingsBtn');
            const videoEndCallBtn = document.getElementById('videoEndCallBtn');
            const connectionStatus = document.getElementById('connectionStatus');
            const typingIndicator = document.getElementById('typingIndicator');
            const typingUserName = document.getElementById('typingUserName');
            const emojiBtn = document.getElementById('emojiBtn');
            const attachBtn = document.getElementById('attachBtn');
            const fileInput = document.getElementById('fileInput');
            const incomingCallNotification = document.getElementById('incomingCallNotification');
            const incomingCallName = document.getElementById('incomingCallName');
            const incomingCallType = document.getElementById('incomingCallType');
            const incomingCallAvatar = document.getElementById('incomingCallAvatar');
            const acceptCallBtn = document.getElementById('acceptCallBtn');
            const rejectCallBtn = document.getElementById('rejectCallBtn');
            const devicePermissionModal = document.getElementById('devicePermissionModal');
            const cameraSelect = document.getElementById('cameraSelect');
            const microphoneSelect = document.getElementById('microphoneSelect');
            const speakerSelect = document.getElementById('speakerSelect');
            const confirmDevicesBtn = document.getElementById('confirmDevicesBtn');
            const cancelDevicesBtn = document.getElementById('cancelDevicesBtn');
            const deviceSettingsBtn = document.getElementById('deviceSettingsBtn');
            const deviceSettingsPanel = document.getElementById('deviceSettingsPanel');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const cameraSettingsSelect = document.getElementById('cameraSettingsSelect');
            const microphoneSettingsSelect = document.getElementById('microphoneSettingsSelect');
            const speakerSettingsSelect = document.getElementById('speakerSettingsSelect');
            const testAudioBtn = document.getElementById('testAudioBtn');
            const testVideoBtn = document.getElementById('testVideoBtn');

            // Initialize
            document.addEventListener('DOMContentLoaded', function() {
                initializeWebSocket();
                loadAppointments();
                setupEventListeners();
                setWelcomeTime();
                checkFirstTimeUser();
            });

            // Initialize WebSocket connection
            function initializeWebSocket() {
                // In a real implementation, this would connect to your WebSocket server
                console.log('WebSocket connection initialized');
                isSocketConnected = true;
                
                // Simulate receiving messages for demo
                setInterval(() => {
                    if (currentAppointment && Math.random() > 0.7) {
                        const messages = [
                            "Hello, how are you feeling today?",
                            "I've reviewed your test results and they look good.",
                            "Please remember to take your medication as prescribed.",
                            "Do you have any questions about your treatment plan?",
                            "Your next appointment is scheduled for next week."
                        ];
                        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                        
                        handleNewMessage({
                            id: Date.now(),
                            appointment_id: currentAppointment.id,
                            sender_id: currentAppointment.doctor_id || 2,
                            content: randomMessage,
                            message_type: 'text',
                            created_at: new Date().toISOString(),
                            is_own: false
                        });
                    }
                }, 15000);
            }

            // Setup event listeners
            function setupEventListeners() {
                // Toggle sidebar on mobile
                toggleSidebar.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });

                // Message sending
                sendBtn.addEventListener('click', sendMessage);
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                // Typing indicator
                messageInput.addEventListener('input', startTypingIndicator);

                // Auto-resize textarea
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });

                // Call buttons
                voiceCallBtn.addEventListener('click', startVoiceCall);
                videoCallBtn.addEventListener('click', startVideoCall);

                // Voice recording
                startRecordingBtn.addEventListener('click', showVoiceRecorder);
                recordBtn.addEventListener('click', toggleVoiceRecording);
                sendRecordingBtn.addEventListener('click', sendVoiceRecording);
                cancelRecordingBtn.addEventListener('click', cancelVoiceRecording);

                // Voice call controls
                callMuteBtn.addEventListener('click', toggleVoiceMute);
                endCallBtn.addEventListener('click', endCall);

                // Video call controls
                videoMuteBtn.addEventListener('click', toggleMute);
                videoToggleBtn.addEventListener('click', toggleVideo);
                screenShareBtn.addEventListener('click', toggleScreenShare);
                videoRecordBtn.addEventListener('click', toggleRecording);
                videoEndCallBtn.addEventListener('click', endCall);

                // Device permission modal
                confirmDevicesBtn.addEventListener('click', confirmDeviceSelection);
                cancelDevicesBtn.addEventListener('click', cancelDeviceSelection);

                // Device settings
                deviceSettingsBtn.addEventListener('click', toggleDeviceSettings);
                closeSettingsBtn.addEventListener('click', hideDeviceSettings);
                videoSettingsBtn.addEventListener('click', toggleDeviceSettings);

                // Device testing
                testAudioBtn.addEventListener('click', testAudioOutput);
                testVideoBtn.addEventListener('click', testVideoOutput);

                // Incoming call
                acceptCallBtn.addEventListener('click', acceptIncomingCall);
                rejectCallBtn.addEventListener('click', rejectIncomingCall);

                // File attachment
                attachBtn.addEventListener('click', () => {
                    fileInput.click();
                });

                fileInput.addEventListener('change', handleFileUpload);

                // Device change listeners
                cameraSettingsSelect.addEventListener('change', handleCameraChange);
                microphoneSettingsSelect.addEventListener('change', handleMicrophoneChange);
                speakerSettingsSelect.addEventListener('change', handleSpeakerChange);
            }

            // Check if this is first time user
            function checkFirstTimeUser() {
                const hasUsedVideoCall = localStorage.getItem('hasUsedVideoCall');
                isFirstTimeUser = !hasUsedVideoCall;
            }

            // Load appointments for the current user
            async function loadAppointments() {
                try {
                    showLoadingState();
                    
                    // In a real implementation, this would fetch from your API
                    const response = await fetch('/api/communication/appointments');
                    if (!response.ok) {
                        throw new Error('Failed to fetch appointments');
                    }
                    
                    const appointments = await response.json();
                    displayAppointments(appointments);
                    
                } catch (error) {
                    console.error('Error loading appointments:', error);
                    // For demo purposes, we'll use sample data
                    const sampleAppointments = [
                        {
                            id: 1,
                            doctor_name: 'Dr. Jane Smith',
                            patient_name: 'John Doe',
                            doctor_id: 2,
                            specialization: 'Cardiology',
                            status: 'confirmed',
                            payment_status: 'completed',
                            appointment_date: new Date(),
                            formatted_date: 'Today, 2:30 PM',
                            unread_count: 0
                        },
                        {
                            id: 2,
                            doctor_name: 'Dr. Michael Johnson',
                            patient_name: 'Sarah Wilson',
                            doctor_id: 3,
                            specialization: 'Dermatology',
                            status: 'scheduled',
                            payment_status: 'pending',
                            appointment_date: new Date(Date.now() + 86400000),
                            formatted_date: 'Tomorrow, 10:00 AM',
                            unread_count: 3
                        }
                    ];
                    
                    displayAppointments(sampleAppointments);
                }
            }

            // Display appointments in the sidebar
            function displayAppointments(appointments) {
                if (!appointmentList) return;
                
                appointmentList.innerHTML = '';
                
                if (!appointments || appointments.length === 0) {
                    showEmptyState();
                    return;
                }
                
                hideEmptyState();
                hideLoadingState();
                
                appointments.forEach(apt => {
                    const appointmentItem = createAppointmentElement(apt);
                    appointmentList.appendChild(appointmentItem);
                });
            }

            // Create appointment element
            function createAppointmentElement(apt) {
                const appointmentItem = document.createElement('div');
                appointmentItem.className = 'appointment-item';
                appointmentItem.dataset.appointmentId = apt.id;
                
                const statusClass = `status-${apt.status ? apt.status.toLowerCase() : 'scheduled'}`;
                const paymentClass = `payment-${apt.payment_status ? apt.payment_status.toLowerCase() : 'pending'}`;
                
                // Use the correct name based on user role (simulated as patient)
                const displayName = apt.doctor_name || 'Doctor';
                const specialization = apt.specialization || 'Medical Consultation';
                const formattedDate = apt.formatted_date || 'Date not set';
                const status = apt.status || 'scheduled';
                const paymentStatus = apt.payment_status || 'pending';
                const unreadCount = apt.unread_count || 0;
                
                appointmentItem.innerHTML = `
                    <div class="appointment-info">
                        <h3>${displayName}</h3>
                        <p>${specialization}</p>
                        <p>${formattedDate}</p>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <span class="appointment-status ${statusClass}">${status}</span>
                            <span class="payment-status ${paymentClass}">${paymentStatus}</span>
                            ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount} unread</span>` : ''}
                        </div>
                    </div>
                `;
                
                appointmentItem.addEventListener('click', () => {
                    selectAppointment(apt, appointmentItem);
                });
                
                return appointmentItem;
            }

            // Select an appointment
            function selectAppointment(appointment, element) {
                // Update active state
                document.querySelectorAll('.appointment-item').forEach(item => {
                    item.classList.remove('active');
                });
                element.classList.add('active');
                
                currentAppointment = appointment;
                
                // Update contact info
                contactAvatar.innerHTML = '<i class="fas fa-user-md"></i>';
                contactName.textContent = appointment.doctor_name || 'Doctor';
                contactStatus.textContent = `${appointment.specialization || 'Medical Consultation'} • ${appointment.status || 'scheduled'}`;
                
                // Enable communication features
                enableCommunicationFeatures();
                
                // Load messages for this appointment
                loadMessages(appointment.id);
                
                // Mark messages as read
                markMessagesAsRead(appointment.id);
                
                // On mobile, close sidebar after selection
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                }
            }

            // Load messages for an appointment
            async function loadMessages(appointmentId) {
                try {
                    // In a real implementation, this would fetch from your API
                    const response = await fetch(`/api/messages/${appointmentId}`);
                    if (!response.ok) {
                        throw new Error('Failed to load messages');
                    }
                    
                    const messages = await response.json();
                    displayMessages(messages);
                    
                } catch (error) {
                    console.error('Error loading messages:', error);
                    // For demo, show sample messages
                    const sampleMessages = [
                        {
                            id: 1,
                            appointment_id: appointmentId,
                            sender_id: 1,
                            content: "Hello, I'd like to discuss my treatment plan.",
                            message_type: 'text',
                            created_at: new Date(Date.now() - 3600000).toISOString(),
                            is_own: true
                        },
                        {
                            id: 2,
                            appointment_id: appointmentId,
                            sender_id: currentAppointment.doctor_id || 2,
                            content: "Of course. I've reviewed your latest test results and they look good.",
                            message_type: 'text',
                            created_at: new Date(Date.now() - 1800000).toISOString(),
                            is_own: false
                        }
                    ];
                    
                    displayMessages(sampleMessages);
                }
            }

            // Display messages in the chat
            function displayMessages(messages) {
                if (!messagesContainer) return;
                
                messagesContainer.innerHTML = '';
                
                if (messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div class="message received">
                            <div class="message-text">
                                No messages yet. Start the conversation!
                            </div>
                            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                    `;
                    return;
                }
                
                messages.forEach(msg => {
                    addMessageToChat(msg, false);
                });
                
                scrollToBottom();
            }

            // Add message to chat
            function addMessageToChat(message, shouldScroll = true) {
                if (!messagesContainer) return;
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.is_own ? 'sent' : 'received'}`;
                
                let messageContent = '';
                
                if (message.message_type === 'audio') {
                    messageContent = `
                        <div class="audio-message">
                            <audio controls class="audio-player">
                                <source src="${message.audio_url}" type="audio/webm">
                                Your browser does not support the audio element.
                            </audio>
                            <div class="audio-duration">${formatDuration(message.duration || 0)}</div>
                        </div>
                        <div class="message-time">${formatTime(message.created_at)}</div>
                        ${message.is_own ? '<div class="message-status">✓✓</div>' : ''}
                    `;
                } else {
                    messageContent = `
                        <div class="message-text">${escapeHtml(message.content)}</div>
                        <div class="message-time">${formatTime(message.created_at)}</div>
                        ${message.is_own ? '<div class="message-status">✓✓</div>' : ''}
                    `;
                }
                
                messageElement.innerHTML = messageContent;
                messagesContainer.appendChild(messageElement);
                
                if (shouldScroll) {
                    scrollToBottom();
                }
            }

            // Handle new message from WebSocket
            function handleNewMessage(messageData) {
                if (!currentAppointment || messageData.appointment_id !== currentAppointment.id) {
                    // Message for different appointment, show notification
                    playNotificationSound();
                    return;
                }
                
                // Add message to chat
                addMessageToChat(messageData, true);
                
                // Update unread count in sidebar
                updateUnreadCount(messageData.appointment_id, 1);
                
                // Play notification sound for messages from others
                if (!messageData.is_own) {
                    playNotificationSound();
                }
            }

            // Send text message
            async function sendMessage() {
                if (!currentAppointment || !messageInput.value.trim()) return;
                
                const content = messageInput.value.trim();
                
                try {
                    // In a real implementation, this would send via WebSocket or API
                    const messageData = {
                        id: Date.now(),
                        appointment_id: currentAppointment.id,
                        sender_id: 1, // Current user ID
                        content: content,
                        message_type: 'text',
                        created_at: new Date().toISOString(),
                        is_own: true
                    };
                    
                    // Add message to chat immediately for better UX
                    addMessageToChat(messageData, true);
                    
                    // Clear input
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    
                    // Stop typing indicator
                    stopTypingIndicator();
                    
                    // Simulate sending via WebSocket
                    if (isSocketConnected) {
                        // In a real app, this would be: socket.emit('send_message', messageData);
                        console.log('Message sent:', messageData);
                    }
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Error sending message. Please try again.');
                }
            }

            // Start typing indicator
            function startTypingIndicator() {
                if (!currentAppointment || !isSocketConnected) return;
                
                // In a real app, this would be: socket.emit('typing_start', { appointment_id: currentAppointment.id });
                
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                }

                typingTimeout = setTimeout(() => {
                    stopTypingIndicator();
                }, 3000);
            }

            // Stop typing indicator
            function stopTypingIndicator() {
                if (!currentAppointment || !isSocketConnected) return;
                
                // In a real app, this would be: socket.emit('typing_stop', { appointment_id: currentAppointment.id });
                
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                    typingTimeout = null;
                }
            }

            // Show loading state
            function showLoadingState() {
                if (loadingState) loadingState.style.display = 'block';
                if (emptyState) emptyState.style.display = 'none';
            }

            // Hide loading state
            function hideLoadingState() {
                if (loadingState) loadingState.style.display = 'none';
            }

            // Show empty state
            function showEmptyState() {
                if (emptyState) emptyState.style.display = 'block';
                if (loadingState) loadingState.style.display = 'none';
            }

            // Hide empty state
            function hideEmptyState() {
                if (emptyState) emptyState.style.display = 'none';
            }

            // Show error state
            function showErrorState(message) {
                if (!appointmentList) return;
                
                appointmentList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚠️</div>
                        <h3>Error Loading Appointments</h3>
                        <p>${message}</p>
                        <button class="refresh-button" onclick="loadAppointments()">
                            <i class="fas fa-sync-alt"></i> Try Again
                        </button>
                    </div>
                `;
            }

            // Enable communication features
            function enableCommunicationFeatures() {
                messageInput.disabled = false;
                sendBtn.disabled = false;
                voiceCallBtn.disabled = false;
                videoCallBtn.disabled = false;
                startRecordingBtn.disabled = false;
                emojiBtn.disabled = false;
                attachBtn.disabled = false;
                messageInput.placeholder = "Type a message...";
            }

            // Mark messages as read
            async function markMessagesAsRead(appointmentId) {
                try {
                    // In a real implementation, this would call your API
                    await fetch(`/api/messages/${appointmentId}/mark_read`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    // Clear unread badge
                    const appointmentItem = document.querySelector(`[data-appointment-id="${appointmentId}"]`);
                    if (appointmentItem) {
                        const unreadBadge = appointmentItem.querySelector('.unread-badge');
                        if (unreadBadge) {
                            unreadBadge.remove();
                        }
                    }
                } catch (error) {
                    console.error('Error marking messages as read:', error);
                }
            }

            // Update unread count
            function updateUnreadCount(appointmentId, newMessageCount) {
                const appointmentItem = document.querySelector(`[data-appointment-id="${appointmentId}"]`);
                if (appointmentItem) {
                    let unreadBadge = appointmentItem.querySelector('.unread-badge');
                    let currentCount = 0;
                    
                    if (unreadBadge) {
                        currentCount = parseInt(unreadBadge.textContent) || 0;
                        unreadBadge.textContent = `${currentCount + newMessageCount} unread`;
                    } else {
                        unreadBadge = document.createElement('span');
                        unreadBadge.className = 'unread-badge';
                        unreadBadge.textContent = `${newMessageCount} unread`;
                        appointmentItem.querySelector('.appointment-info').appendChild(unreadBadge);
                    }
                }
            }

            // Set welcome message time
            function setWelcomeTime() {
                const timeElement = document.getElementById('welcomeTime');
                if (timeElement) {
                    timeElement.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
            }

            // ==================== VOICE CALL FUNCTIONS ====================

            // Start voice call
            async function startVoiceCall() {
                if (!currentAppointment) return;
                
                try {
                    // Request permission for microphone only
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true,
                        video: false 
                    });
                    
                    isVideoCall = false;
                    showVoiceCallInterface();
                    startCallTimer();
                    
                    // Update caller name
                    const callerAvatar = document.getElementById('callerAvatar');
                    callerAvatar.innerHTML = '<i class="fas fa-user-md"></i>';
                    
                    // Initialize voice call
                    initializeVoiceCall(stream);
                    
                    // Simulate remote participant answering after 3 seconds
                    setTimeout(() => {
                        callStatus.textContent = 'Connected';
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error starting voice call:', error);
                    alert('Cannot access microphone. Please check permissions.');
                }
            }

            // Initialize voice call
            function initializeVoiceCall(stream) {
                localStream = stream;
                initializePeerConnection();
                
                // Add audio tracks to peer connection
                localStream.getAudioTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            // Show voice call interface
            function showVoiceCallInterface() {
                voiceCallInterface.style.display = 'flex';
                callStatus.textContent = 'Calling...';
                isInCall = true;
            }

            // Toggle voice mute
            function toggleVoiceMute() {
                if (localStream) {
                    const audioTracks = localStream.getAudioTracks();
                    let isMuted = false;
                    
                    audioTracks.forEach(track => {
                        track.enabled = !track.enabled;
                        isMuted = !track.enabled;
                    });
                    
                    callMuteBtn.classList.toggle('muted', isMuted);
                    callMuteBtn.innerHTML = isMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
                }
            }

            // ==================== VIDEO CALL FUNCTIONS ====================

            // Start video call
            async function startVideoCall() {
                if (!currentAppointment) return;
                
                try {
                    // Show device permission modal for first-time users
                    if (isFirstTimeUser || !devicePermissionsGranted) {
                        await showDevicePermissionModal();
                        return;
                    }
                    
                    // Get user media with selected devices
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: selectedCameraId ? { deviceId: { exact: selectedCameraId } } : true,
                        audio: selectedMicrophoneId ? { deviceId: { exact: selectedMicrophoneId } } : true
                    });
                    
                    isVideoCall = true;
                    showVideoCallInterface();
                    startCallTimer();
                    
                    // Update caller name
                    videoCallerName.textContent = currentAppointment.doctor_name || 'Doctor';
                    
                    await initializeVideoCall(stream);
                    
                    // Simulate remote participant joining after 3 seconds
                    setTimeout(() => {
                        videoCallStatus.textContent = 'Connected';
                        updateConnectionStatus('connected', 'Call connected');
                        
                        // Simulate remote video (in a real app, this would come from WebRTC)
                        simulateRemoteVideo();
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error starting video call:', error);
                    if (error.name === 'NotAllowedError') {
                        alert('Camera/microphone access was denied. Please allow permissions and try again.');
                    } else if (error.name === 'NotFoundError') {
                        alert('No camera/microphone found. Please check your devices.');
                    } else {
                        alert('Cannot access camera/microphone. Please check permissions.');
                    }
                }
            }

            // Initialize video call
            async function initializeVideoCall(stream) {
                localStream = stream;
                
                // Display local video
                if (localVideo) {
                    localVideo.srcObject = stream;
                }
                
                await initializePeerConnection();
                
                // Add local stream tracks to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                updateConnectionStatus('connecting', 'Establishing connection...');
            }

            // Initialize peer connection
            async function initializePeerConnection() {
                try {
                    peerConnection = new RTCPeerConnection(configuration);
                    
                    // Handle incoming remote stream
                    peerConnection.ontrack = (event) => {
                        console.log('Received remote stream:', event.streams);
                        remoteStream = event.streams[0];
                        if (remoteStream && remoteVideo) {
                            remoteVideo.srcObject = remoteStream;
                        }
                    };
                    
                    // Handle ICE candidates
                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            // Send candidate to remote peer (simulated)
                            console.log('ICE candidate generated');
                        }
                    };
                    
                    // Handle connection state changes
                    peerConnection.onconnectionstatechange = () => {
                        console.log('Connection state:', peerConnection.connectionState);
                        switch (peerConnection.connectionState) {
                            case 'connected':
                                updateConnectionStatus('connected', 'Connected');
                                break;
                            case 'disconnected':
                            case 'failed':
                                updateConnectionStatus('disconnected', 'Connection lost');
                                break;
                            case 'connecting':
                                updateConnectionStatus('connecting', 'Connecting...');
                                break;
                        }
                    };
                    
                } catch (error) {
                    console.error('Error initializing peer connection:', error);
                    throw error;
                }
            }

            // Show video call interface
            function showVideoCallInterface() {
                videoCallInterface.style.display = 'flex';
                videoCallStatus.textContent = 'Calling...';
                isInCall = true;
            }

            // End call
            function endCall() {
                // Stop local stream
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                // Stop remote stream
                if (remoteStream) {
                    remoteStream.getTracks().forEach(track => track.stop());
                    remoteStream = null;
                }
                
                // Close peer connection
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                
                // Stop screen sharing if active
                if (isScreenSharing) {
                    stopScreenShare();
                }
                
                // Stop recording if active
                if (isRecording) {
                    stopRecording();
                }
                
                // Hide call interfaces
                voiceCallInterface.style.display = 'none';
                videoCallInterface.style.display = 'none';
                hideDeviceSettings();
                
                // Stop timers
                stopCallTimer();
                
                // Reset call state
                isVideoCall = false;
                isInCall = false;
                
                updateConnectionStatus('disconnected', 'Call ended');
            }

            // Toggle mute
            function toggleMute() {
                if (localStream) {
                    const audioTracks = localStream.getAudioTracks();
                    let isMuted = false;
                    
                    audioTracks.forEach(track => {
                        track.enabled = !track.enabled;
                        isMuted = !track.enabled;
                    });
                    
                    videoMuteBtn.classList.toggle('muted', isMuted);
                    videoMuteBtn.innerHTML = isMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
                    
                    // Update participant status
                    const localParticipant = document.getElementById('localParticipant');
                    const statusIndicator = localParticipant.querySelector('.participant-status');
                    statusIndicator.classList.toggle('muted', isMuted);
                }
            }

            // Toggle video
            function toggleVideo() {
                if (localStream && isVideoCall) {
                    const videoTracks = localStream.getVideoTracks();
                    let isVideoOff = false;
                    
                    videoTracks.forEach(track => {
                        track.enabled = !track.enabled;
                        isVideoOff = !track.enabled;
                    });
                    
                    videoToggleBtn.classList.toggle('off', isVideoOff);
                    videoToggleBtn.innerHTML = isVideoOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
                    
                    // Show/hide video element or placeholder
                    if (localVideo) {
                        if (isVideoOff) {
                            localVideo.style.display = 'none';
                            // Show placeholder (in a real app, you might show a static image)
                        } else {
                            localVideo.style.display = 'block';
                        }
                    }
                }
            }

            // Toggle screen share
            async function toggleScreenShare() {
                if (!isScreenSharing) {
                    try {
                        const screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                            video: true,
                            audio: true 
                        });
                        
                        // Replace video track with screen share
                        const videoTrack = screenStream.getVideoTracks()[0];
                        const sender = peerConnection.getSenders().find(s => 
                            s.track && s.track.kind === 'video'
                        );
                        
                        if (sender) {
                            await sender.replaceTrack(videoTrack);
                        }
                        
                        // Update local video to show screen share
                        localVideo.srcObject = screenStream;
                        
                        isScreenSharing = true;
                        screenShareBtn.classList.add('active');
                        
                        // Handle when user stops screen sharing
                        videoTrack.onended = () => {
                            stopScreenShare();
                        };
                        
                    } catch (error) {
                        console.error('Error starting screen share:', error);
                    }
                } else {
                    stopScreenShare();
                }
            }

            // Stop screen share
            async function stopScreenShare() {
                if (localStream && isScreenSharing) {
                    // Get original video track
                    const originalVideoTrack = localStream.getVideoTracks()[0];
                    const sender = peerConnection.getSenders().find(s => 
                        s.track && s.track.kind === 'video'
                    );
                    
                    if (sender && originalVideoTrack) {
                        await sender.replaceTrack(originalVideoTrack);
                    }
                    
                    // Restore local video
                    localVideo.srcObject = localStream;
                    
                    isScreenSharing = false;
                    screenShareBtn.classList.remove('active');
                }
            }

            // Toggle recording
            function toggleRecording() {
                if (!isRecording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            }

            // Start recording
            function startRecording() {
                if (!localStream) return;
                
                try {
                    recordedChunks = [];
                    const options = { mimeType: 'video/webm; codecs=vp9' };
                    mediaRecorder = new MediaRecorder(localStream, options);
                    
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(recordedChunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        
                        // In a real app, you would upload this to your server
                        console.log('Recording saved:', url);
                        
                        // Create a download link (for demo purposes)
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `consultation-${new Date().toISOString()}.webm`;
                        a.click();
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    videoRecordBtn.classList.add('recording');
                    
                } catch (error) {
                    console.error('Error starting recording:', error);
                }
            }

            // Stop recording
            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    videoRecordBtn.classList.remove('recording');
                }
            }

            // Call timer functions
            function startCallTimer() {
                callSeconds = 0;
                updateCallTimer();
                
                callTimer = setInterval(() => {
                    callSeconds++;
                    updateCallTimer();
                }, 1000);
            }

            function stopCallTimer() {
                if (callTimer) {
                    clearInterval(callTimer);
                    callTimer = null;
                }
            }

            function updateCallTimer() {
                const minutes = Math.floor(callSeconds / 60);
                const seconds = callSeconds % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (isVideoCall) {
                    videoCallDuration.textContent = timeString;
                } else {
                    callDuration.textContent = timeString;
                }
            }

            // Update connection status
            function updateConnectionStatus(status, message) {
                if (!connectionStatus) return;
                
                connectionStatus.textContent = message;
                connectionStatus.className = `connection-status ${status}`;
                connectionStatus.style.display = 'block';
                
                if (status === 'connected') {
                    setTimeout(() => {
                        connectionStatus.style.display = 'none';
                    }, 3000);
                }
            }

            // ==================== VOICE RECORDING FUNCTIONS ====================

            // Show voice recorder
            function showVoiceRecorder() {
                voiceRecorder.style.display = 'flex';
            }

            // Toggle voice recording
            function toggleVoiceRecording() {
                if (!isVoiceRecording) {
                    startVoiceRecording();
                } else {
                    stopVoiceRecording();
                }
            }

            // Start voice recording
            function startVoiceRecording() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Audio recording is not supported in your browser');
                    return;
                }

                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        voiceMediaRecorder = new MediaRecorder(stream);
                        voiceAudioChunks = [];

                        voiceMediaRecorder.ondataavailable = event => {
                            voiceAudioChunks.push(event.data);
                        };

                        voiceMediaRecorder.onstop = () => {
                            const audioBlob = new Blob(voiceAudioChunks, { type: 'audio/webm' });
                            // In a real app, you would upload this to your server
                            console.log('Voice recording completed:', audioBlob);
                            
                            // For demo, we'll create a URL for playback
                            const audioUrl = URL.createObjectURL(audioBlob);
                            
                            // Create a message with the audio
                            const messageData = {
                                id: Date.now(),
                                appointment_id: currentAppointment.id,
                                sender_id: 1, // Current user ID
                                content: 'Voice message',
                                message_type: 'audio',
                                audio_url: audioUrl,
                                duration: voiceRecordingSeconds,
                                created_at: new Date().toISOString(),
                                is_own: true
                            };
                            
                            // Add to chat
                            addMessageToChat(messageData, true);
                            
                            // Hide recorder
                            voiceRecorder.style.display = 'none';
                            
                            // Reset recording state
                            isVoiceRecording = false;
                            voiceRecordingSeconds = 0;
                            recordingTimerDisplay.textContent = '00:00';
                            recordBtn.classList.remove('recording');
                            sendRecordingBtn.disabled = true;
                        };

                        voiceMediaRecorder.start();
                        startVoiceRecordingTimer();
                        isVoiceRecording = true;
                        recordBtn.classList.add('recording');
                        sendRecordingBtn.disabled = true;
                    })
                    .catch(error => {
                        console.error('Error accessing microphone:', error);
                        alert('Cannot access microphone. Please check permissions.');
                    });
            }

            // Stop voice recording
            function stopVoiceRecording() {
                if (voiceMediaRecorder && voiceMediaRecorder.state === 'recording') {
                    voiceMediaRecorder.stop();
                    voiceMediaRecorder.stream.getTracks().forEach(track => track.stop());
                    stopVoiceRecordingTimer();
                    sendRecordingBtn.disabled = false;
                }
            }

            // Start voice recording timer
            function startVoiceRecordingTimer() {
                voiceRecordingSeconds = 0;
                recordingTimerDisplay.textContent = '00:00';
                
                voiceRecordingTimer = setInterval(() => {
                    voiceRecordingSeconds++;
                    const minutes = Math.floor(voiceRecordingSeconds / 60);
                    const seconds = voiceRecordingSeconds % 60;
                    recordingTimerDisplay.textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            // Stop voice recording timer
            function stopVoiceRecordingTimer() {
                if (voiceRecordingTimer) {
                    clearInterval(voiceRecordingTimer);
                    voiceRecordingTimer = null;
                }
            }

            // Send voice recording
            function sendVoiceRecording() {
                stopVoiceRecording();
                // The recording will be automatically sent when stopped
            }

            // Cancel voice recording
            function cancelVoiceRecording() {
                if (voiceMediaRecorder && voiceMediaRecorder.state === 'recording') {
                    voiceMediaRecorder.stop();
                    voiceMediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
                
                stopVoiceRecordingTimer();
                voiceRecorder.style.display = 'none';
                voiceAudioChunks = [];
                isVoiceRecording = false;
                voiceRecordingSeconds = 0;
                recordingTimerDisplay.textContent = '00:00';
                recordBtn.classList.remove('recording');
                sendRecordingBtn.disabled = true;
            }

            // ==================== INCOMING CALL FUNCTIONS ====================

            // Show incoming call notification
            function showIncomingCallNotification(callerName, callType) {
                incomingCallName.textContent = callerName;
                incomingCallType.textContent = callType === 'video' ? 'Video Call' : 'Voice Call';
                incomingCallAvatar.innerHTML = callType === 'video' ? '<i class="fas fa-video"></i>' : '<i class="fas fa-phone"></i>';
                
                incomingCallNotification.style.display = 'block';
                incomingCallAvatar.classList.add('ringing');
                
                // Play ringtone
                playIncomingRingtone();
            }

            // Accept incoming call
            function acceptIncomingCall() {
                stopIncomingRingtone();
                hideIncomingCallNotification();
                
                // Start the appropriate call type
                if (incomingCallType.textContent === 'Video Call') {
                    startVideoCall();
                } else {
                    startVoiceCall();
                }
            }

            // Reject incoming call
            function rejectIncomingCall() {
                stopIncomingRingtone();
                hideIncomingCallNotification();
            }

            // Hide incoming call notification
            function hideIncomingCallNotification() {
                incomingCallNotification.style.display = 'none';
                incomingCallAvatar.classList.remove('ringing');
            }

            // Play incoming ringtone
            function playIncomingRingtone() {
                // In a real app, this would play an actual ringtone
                console.log('Playing incoming ringtone');
            }

            // Stop incoming ringtone
            function stopIncomingRingtone() {
                // In a real app, this would stop the ringtone
                console.log('Stopping incoming ringtone');
            }

            // ==================== DEVICE MANAGEMENT ====================

            // Show device permission modal
            async function showDevicePermissionModal() {
                try {
                    await enumerateDevices();
                    populateDeviceSelects();
                    devicePermissionModal.style.display = 'flex';
                } catch (error) {
                    console.error('Error showing device permission modal:', error);
                    alert('Error accessing devices. Please check your browser permissions.');
                }
            }

            // Hide device permission modal
            function hideDevicePermissionModal() {
                devicePermissionModal.style.display = 'none';
            }

            // Enumerate available devices
            async function enumerateDevices() {
                try {
                    // Request permission first by trying to get user media
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: true 
                    });
                    
                    // Stop the stream immediately since we just needed permission
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Now enumerate devices
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    
                    availableCameras = devices.filter(device => device.kind === 'videoinput');
                    availableMicrophones = devices.filter(device => device.kind === 'audioinput');
                    availableSpeakers = devices.filter(device => device.kind === 'audiooutput');
                    
                    // Set default selections
                    if (availableCameras.length > 0) {
                        selectedCameraId = availableCameras[0].deviceId;
                    }
                    if (availableMicrophones.length > 0) {
                        selectedMicrophoneId = availableMicrophones[0].deviceId;
                    }
                    if (availableSpeakers.length > 0) {
                        selectedSpeakerId = availableSpeakers[0].deviceId;
                    }
                    
                    devicePermissionsGranted = true;
                    
                } catch (error) {
                    console.error('Error enumerating devices:', error);
                    throw error;
                }
            }

            // Populate device selects
            function populateDeviceSelects() {
                // Populate camera selects
                cameraSelect.innerHTML = '';
                cameraSettingsSelect.innerHTML = '';
                availableCameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.textContent = camera.label || `Camera ${cameraSelect.length + 1}`;
                    cameraSelect.appendChild(option.cloneNode(true));
                    cameraSettingsSelect.appendChild(option);
                });
                
                // Populate microphone selects
                microphoneSelect.innerHTML = '';
                microphoneSettingsSelect.innerHTML = '';
                availableMicrophones.forEach(microphone => {
                    const option = document.createElement('option');
                    option.value = microphone.deviceId;
                    option.textContent = microphone.label || `Microphone ${microphoneSelect.length + 1}`;
                    microphoneSelect.appendChild(option.cloneNode(true));
                    microphoneSettingsSelect.appendChild(option);
                });
                
                // Populate speaker selects
                speakerSelect.innerHTML = '';
                speakerSettingsSelect.innerHTML = '';
                availableSpeakers.forEach(speaker => {
                    const option = document.createElement('option');
                    option.value = speaker.deviceId;
                    option.textContent = speaker.label || `Speaker ${speakerSelect.length + 1}`;
                    speakerSelect.appendChild(option.cloneNode(true));
                    speakerSettingsSelect.appendChild(option);
                });
                
                // Set selected values
                if (selectedCameraId) {
                    cameraSelect.value = selectedCameraId;
                    cameraSettingsSelect.value = selectedCameraId;
                }
                if (selectedMicrophoneId) {
                    microphoneSelect.value = selectedMicrophoneId;
                    microphoneSettingsSelect.value = selectedMicrophoneId;
                }
                if (selectedSpeakerId) {
                    speakerSelect.value = selectedSpeakerId;
                    speakerSettingsSelect.value = selectedSpeakerId;
                }
            }

            // Confirm device selection
            function confirmDeviceSelection() {
                selectedCameraId = cameraSelect.value;
                selectedMicrophoneId = microphoneSelect.value;
                selectedSpeakerId = speakerSelect.value;
                
                // Mark as not first time user
                localStorage.setItem('hasUsedVideoCall', 'true');
                isFirstTimeUser = false;
                
                hideDevicePermissionModal();
                
                // Apply speaker selection
                applySpeakerSelection();
                
                // Start the call after device selection
                startVideoCall();
            }

            // Cancel device selection
            function cancelDeviceSelection() {
                hideDevicePermissionModal();
            }

            // Apply speaker selection
            function applySpeakerSelection() {
                if (selectedSpeakerId && remoteVideo) {
                    // For modern browsers that support setSinkId
                    if (remoteVideo.setSinkId) {
                        remoteVideo.setSinkId(selectedSpeakerId)
                            .then(() => {
                                console.log('Speaker set successfully');
                            })
                            .catch(error => {
                                console.error('Error setting speaker:', error);
                            });
                    }
                }
            }

            // Toggle device settings
            function toggleDeviceSettings() {
                if (deviceSettingsPanel.style.display === 'block') {
                    hideDeviceSettings();
                } else {
                    showDeviceSettings();
                }
            }

            // Show device settings
            function showDeviceSettings() {
                deviceSettingsPanel.style.display = 'block';
            }

            // Hide device settings
            function hideDeviceSettings() {
                deviceSettingsPanel.style.display = 'none';
            }

            // Handle camera change
            async function handleCameraChange() {
                selectedCameraId = cameraSettingsSelect.value;
                if (localStream && isInCall) {
                    await restartVideoWithNewCamera();
                }
            }

            // Handle microphone change
            async function handleMicrophoneChange() {
                selectedMicrophoneId = microphoneSettingsSelect.value;
                if (localStream && isInCall) {
                    await restartAudioWithNewMicrophone();
                }
            }

            // Handle speaker change
            function handleSpeakerChange() {
                selectedSpeakerId = speakerSettingsSelect.value;
                applySpeakerSelection();
            }

            // Restart video with new camera
            async function restartVideoWithNewCamera() {
                try {
                    const videoTrack = localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.stop();
                    }
                    
                    const newStream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: selectedCameraId ? { exact: selectedCameraId } : undefined },
                        audio: false
                    });
                    
                    const newVideoTrack = newStream.getVideoTracks()[0];
                    const sender = peerConnection.getSenders().find(s => 
                        s.track && s.track.kind === 'video'
                    );
                    
                    if (sender) {
                        await sender.replaceTrack(newVideoTrack);
                    }
                    
                    // Add new track to local stream
                    localStream.addTrack(newVideoTrack);
                    
                    // Update local video
                    if (localVideo) {
                        localVideo.srcObject = localStream;
                    }
                    
                } catch (error) {
                    console.error('Error restarting video:', error);
                }
            }

            // Restart audio with new microphone
            async function restartAudioWithNewMicrophone() {
                try {
                    const audioTrack = localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.stop();
                    }
                    
                    const newStream = await navigator.mediaDevices.getUserMedia({
                        video: false,
                        audio: { deviceId: selectedMicrophoneId ? { exact: selectedMicrophoneId } : undefined }
                    });
                    
                    const newAudioTrack = newStream.getAudioTracks()[0];
                    const sender = peerConnection.getSenders().find(s => 
                        s.track && s.track.kind === 'audio'
                    );
                    
                    if (sender) {
                        await sender.replaceTrack(newAudioTrack);
                    }
                    
                    // Add new track to local stream
                    localStream.addTrack(newAudioTrack);
                    
                } catch (error) {
                    console.error('Error restarting audio:', error);
                }
            }

            // Test audio output
            function testAudioOutput() {
                // Create a simple test tone
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(context.destination);
                
                oscillator.frequency.value = 440;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                }, 500);
            }

            // Test video output
            function testVideoOutput() {
                if (localVideo && localVideo.srcObject) {
                    // Flash the local video to indicate it's working
                    localVideo.style.border = '3px solid #4caf50';
                    setTimeout(() => {
                        localVideo.style.border = 'none';
                    }, 1000);
                }
            }

            // ==================== FILE UPLOAD ====================

            // Handle file upload
            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (file && currentAppointment) {
                    // In a real app, you would upload the file to your server
                    console.log('File selected for upload:', file);
                    
                    // Create a message with the file info
                    const messageData = {
                        id: Date.now(),
                        appointment_id: currentAppointment.id,
                        sender_id: 1, // Current user ID
                        content: `File: ${file.name}`,
                        message_type: 'file',
                        file_name: file.name,
                        file_size: file.size,
                        created_at: new Date().toISOString(),
                        is_own: true
                    };
                    
                    // Add to chat
                    addMessageToChat(messageData, true);
                    
                    // Reset file input
                    fileInput.value = '';
                }
            }

            // ==================== UTILITY FUNCTIONS ====================

            // Simulate remote video for demo purposes
            function simulateRemoteVideo() {
                // In a real application, this would be handled by WebRTC
                // For demo, we'll create a colored canvas as a placeholder
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                const ctx = canvas.getContext('2d');
                
                // Fill with a color
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add some text
                ctx.fillStyle = '#ecf0f1';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Remote Participant', canvas.width/2, canvas.height/2);
                
                // Convert to stream
                const stream = canvas.captureStream(25);
                remoteVideo.srcObject = stream;
            }

            // Play notification sound
            function playNotificationSound() {
                // In a real app, this would play a sound
                console.log('Playing notification sound');
            }

            // Format time
            function formatTime(isoString) {
                return new Date(isoString).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }

            // Format duration
            function formatDuration(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // Scroll to bottom of messages
            function scrollToBottom() {
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            // Escape HTML
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // Make functions globally available
            window.loadAppointments = loadAppointments;

        })(); // End of IIFE
    </script>
</body>
</html>