<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Call - Makokha Medical Centre</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .voice-call-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .caller-info {
            margin-bottom: 2rem;
        }

        .caller-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        .caller-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .caller-role {
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .call-status {
            font-size: 1rem;
            opacity: 0.7;
        }

        .call-duration {
            font-size: 2rem;
            font-weight: bold;
            margin: 2rem 0;
            color: #48bb78;
        }

        .wave-animation {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin: 2rem 0;
            height: 40px;
        }

        .wave-bar {
            width: 4px;
            height: 20px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
            animation: wave 1.2s ease-in-out infinite;
        }

        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        .wave-bar:nth-child(6) { animation-delay: 0.5s; }
        .wave-bar:nth-child(7) { animation-delay: 0.6s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1.5); }
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .btn-mute {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-mute.muted {
            background: #f56565;
            color: white;
        }

        .btn-speaker {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-speaker.off {
            background: #e53e3e;
            color: white;
        }

        .btn-end {
            background: #f56565;
            color: white;
            width: 70px;
            height: 70px;
        }

        .call-notes {
            margin-top: 2rem;
            text-align: left;
        }

        .call-notes h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .notes-input {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .notes-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .notes-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0;
            padding: 0.5rem 1rem;
            background: rgba(245, 101, 101, 0.3);
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background: #f56565;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 480px) {
            .voice-call-container {
                padding: 1.5rem;
            }

            .caller-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }

            .controls {
                gap: 0.5rem;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .btn-end {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="voice-call-container">
        <div class="caller-info">
            <div class="caller-avatar">
                {% if current_user.role == 'patient' %}üë®‚Äç‚öïÔ∏è{% else %}üë§{% endif %}
            </div>
            <div class="caller-name">
                {% if current_user.role == 'patient' %}
                Dr. {{ appointment.doctor.first_name }} {{ appointment.doctor.last_name }}
                {% else %}
                {{ appointment.patient.first_name }} {{ appointment.patient.last_name }}
                {% endif %}
            </div>
            <div class="caller-role">
                {% if current_user.role == 'patient' %}Doctor{% else %}Patient{% endif %}
            </div>
            <div class="call-status" id="callStatus">Connected</div>
        </div>

        <div class="wave-animation">
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
        </div>

        <div class="call-duration" id="callDuration">00:00</div>

        <div class="recording-indicator">
            <div class="recording-dot"></div>
            Call is being recorded for medical records
        </div>

        <div class="controls">
            <button class="control-btn btn-mute" id="muteBtn" title="Mute">
                üé§
            </button>
            <button class="control-btn btn-speaker" id="speakerBtn" title="Speaker">
                üîà
            </button>
            <button class="control-btn btn-end" id="endCallBtn" title="End Call">
                üìû
            </button>
        </div>

        <div class="call-notes">
            <h3>Consultation Notes</h3>
            <textarea class="notes-input" id="callNotes" 
                      placeholder="Take notes during the consultation..."></textarea>
        </div>
    </div>

    <script>
        // DOM Elements
        const muteBtn = document.getElementById('muteBtn');
        const speakerBtn = document.getElementById('speakerBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const callDuration = document.getElementById('callDuration');
        const callStatus = document.getElementById('callStatus');
        const callNotes = document.getElementById('callNotes');

        // State
        let isMuted = false;
        let isSpeakerOn = true;
        let callStartTime = new Date();
        let durationInterval;

        // Initialize call duration timer
        function startCallTimer() {
            durationInterval = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - callStartTime) / 1000);
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                callDuration.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Toggle mute
        muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            muteBtn.classList.toggle('muted', isMuted);
            muteBtn.title = isMuted ? 'Unmute' : 'Mute';
            // In real implementation: localStream.getAudioTracks()[0].enabled = !isMuted;
        });

        // Toggle speaker
        speakerBtn.addEventListener('click', () => {
            isSpeakerOn = !isSpeakerOn;
            speakerBtn.classList.toggle('off', !isSpeakerOn);
            speakerBtn.title = isSpeakerOn ? 'Turn Off Speaker' : 'Turn On Speaker';
            speakerBtn.textContent = isSpeakerOn ? 'üîà' : 'üîá';
            // In real implementation: adjust audio output device
        });

        // End call
        endCallBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to end the call?')) {
                clearInterval(durationInterval);
                
                // Save notes if any
                if (callNotes.value.trim()) {
                    localStorage.setItem('call_notes_' + Date.now(), callNotes.value);
                }
                
                // In real implementation: close peer connection and streams
                window.close(); // or redirect to dashboard
            }
        });

        // Simulate call connection
        function initializeCall() {
            callStatus.textContent = 'Connecting...';
            
            setTimeout(() => {
                callStatus.textContent = 'Connected';
                startCallTimer();
                
                // In real implementation: initialize WebRTC audio connection
                // navigator.mediaDevices.getUserMedia({ audio: true })
                // .then(stream => {
                //     // Handle audio stream
                // })
                // .catch(error => {
                //     console.error('Error accessing microphone:', error);
                //     callStatus.textContent = 'Connection Failed';
                // });
            }, 2000);
        }

        // Auto-save notes
        callNotes.addEventListener('input', () => {
            localStorage.setItem('current_call_notes', callNotes.value);
        });

        // Load saved notes
        const savedNotes = localStorage.getItem('current_call_notes');
        if (savedNotes) {
            callNotes.value = savedNotes;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeCall);

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            clearInterval(durationInterval);
            if (callNotes.value.trim()) {
                localStorage.setItem('call_notes_' + Date.now(), callNotes.value);
            }
            localStorage.removeItem('current_call_notes');
        });
    </script>
</body>
</html>