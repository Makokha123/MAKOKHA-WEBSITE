<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Makokha Medical Centre</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .signup-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        }

        .signup-header {
            background: #667eea;
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .signup-header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .signup-header p {
            opacity: 0.9;
        }

        .signup-form {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control.error {
            border-color: #f56565;
            box-shadow: 0 0 0 3px rgba(245, 101, 101, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .password-input-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: color 0.3s;
        }

        .password-toggle:hover {
            color: #667eea;
        }

        .password-strength {
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .strength-weak { color: #e53e3e; }
        .strength-medium { color: #dd6b20; }
        .strength-strong { color: #38a169; }

        .password-requirements {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #4a5568;
        }

        .requirement {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .requirement.met {
            color: #38a169;
        }

        .requirement.unmet {
            color: #a0aec0;
        }

        .requirement-icon {
            font-size: 0.75rem;
        }

        .btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-google {
            background: #fff;
            color: #333;
            border: 2px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .btn-google:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
            color: #718096;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e2e8f0;
        }

        .divider span {
            background: white;
            padding: 0 1rem;
        }

        .login-link {
            text-align: center;
            margin-top: 1.5rem;
        }

        .login-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .login-link a:hover {
            text-decoration: underline;
        }

        .flash-messages {
            margin-bottom: 1rem;
        }

        .flash-message {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            animation: slideIn 0.3s ease;
        }

        .flash-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .flash-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .flash-info {
            background: #bee3f8;
            color: #1a365d;
            border: 1px solid #90cdf4;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .back-home {
            text-align: center;
            margin-top: 1rem;
        }

        .back-home a {
            color: #667eea;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-home a:hover {
            text-decoration: underline;
        }

        .error-message {
            color: #e53e3e;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-spinner.show {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .signup-form {
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .signup-header {
                padding: 1.5rem;
            }

            .signup-header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="signup-container">
        <div class="signup-header">
            <h1>Join Makokha Medical</h1>
            <p>Create your patient account to access telemedicine services</p>
        </div>

        <div class="signup-form">
            <!-- Flash Messages -->
            <div class="flash-messages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash-message flash-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <form id="signupForm" method="POST" action="{{ url_for('signup') }}" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Personal Information -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="first_name">First Name *</label>
                        <input type="text" 
                               id="first_name" 
                               name="first_name" 
                               class="form-control" 
                               placeholder="Enter your first name"
                               required
                               maxlength="50">
                        <div class="error-message" id="firstNameError">Please enter your first name</div>
                    </div>
                    <div class="form-group">
                        <label for="last_name">Last Name *</label>
                        <input type="text" 
                               id="last_name" 
                               name="last_name" 
                               class="form-control" 
                               placeholder="Enter your last name"
                               required
                               maxlength="50">
                        <div class="error-message" id="lastNameError">Please enter your last name</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Email Address *</label>
                    <input type="email" 
                           id="email" 
                           name="email" 
                           class="form-control" 
                           placeholder="Enter your email address"
                           required
                           maxlength="120">
                    <div class="error-message" id="emailError">Please enter a valid email address</div>
                </div>

                <div class="form-group">
                    <label for="username">Username (Optional)</label>
                    <input type="text" 
                           id="username" 
                           name="username" 
                           class="form-control" 
                           placeholder="Choose a username"
                           maxlength="80"
                           oninput="checkUsernameAvailability(this.value)">
                    <div class="error-message" id="usernameError">Username is already taken</div>
                    <div class="password-strength" id="usernameAvailability" style="color: #38a169; display: none;">
                        ✓ Username available
                    </div>
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number *</label>
                    <input type="tel" 
                           id="phone" 
                           name="phone" 
                           class="form-control" 
                           placeholder="e.g., +254712345678 or 0712345678"
                           required
                           maxlength="20">
                    <div class="error-message" id="phoneError">Please enter a valid phone number (Kenyan format)</div>
                </div>

                <div class="form-group">
                    <label for="password">Password *</label>
                    <div class="password-input-container">
                        <input type="password" 
                               id="password" 
                               name="password" 
                               class="form-control" 
                               placeholder="Create a strong password"
                               required
                               minlength="8"
                               oninput="checkPasswordStrength(this.value)">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('password')">
                            👁️
                        </button>
                    </div>
                    <div class="error-message" id="passwordError">Password does not meet requirements</div>
                    
                    <!-- Password Requirements -->
                    <div class="password-requirements">
                        <div class="requirement" id="reqLength">
                            <span class="requirement-icon">○</span>
                            At least 8 characters
                        </div>
                        <div class="requirement" id="reqUppercase">
                            <span class="requirement-icon">○</span>
                            One uppercase letter
                        </div>
                        <div class="requirement" id="reqLowercase">
                            <span class="requirement-icon">○</span>
                            One lowercase letter
                        </div>
                        <div class="requirement" id="reqNumber">
                            <span class="requirement-icon">○</span>
                            One number
                        </div>
                        <div class="requirement" id="reqSpecial">
                            <span class="requirement-icon">○</span>
                            One special character
                        </div>
                    </div>
                    
                    <div id="password-strength" class="password-strength"></div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm Password *</label>
                    <div class="password-input-container">
                        <input type="password" 
                               id="confirm_password" 
                               name="confirm_password" 
                               class="form-control" 
                               placeholder="Confirm your password"
                               required
                               oninput="checkPasswordMatch()">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirm_password')">
                            👁️
                        </button>
                    </div>
                    <div class="error-message" id="confirmPasswordError">Passwords do not match</div>
                </div>

                <!-- Patient Specific Fields -->
                <div id="patient-fields" class="patient-fields active">
                    <div class="form-group">
                        <label for="date_of_birth">Date of Birth</label>
                        <input type="date" 
                               id="date_of_birth" 
                               name="date_of_birth" 
                               class="form-control"
                               max="{{ current_date }}">
                    </div>
                    <div class="form-group">
                        <label for="emergency_contact">Emergency Contact</label>
                        <input type="text" 
                               id="emergency_contact" 
                               name="emergency_contact" 
                               class="form-control" 
                               placeholder="Emergency contact person and number"
                               maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="address">Address</label>
                        <textarea id="address" 
                                  name="address" 
                                  class="form-control" 
                                  placeholder="Enter your address"
                                  rows="3"
                                  maxlength="500"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="medical_history">Medical History (Optional)</label>
                        <textarea id="medical_history" 
                                  name="medical_history" 
                                  class="form-control" 
                                  placeholder="Any relevant medical history, allergies, or conditions"
                                  rows="3"
                                  maxlength="1000"></textarea>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="form-group">
                    <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="terms" name="terms" required style="margin-top: 0.25rem;">
                        <span>
                            I agree to the 
                            <a href="#" style="color: #667eea;">Terms of Service</a> 
                            and 
                            <a href="#" style="color: #667eea;">Privacy Policy</a>. 
                            I understand that my medical data will be handled with confidentiality.
                        </span>
                    </label>
                    <div class="error-message" id="termsError">You must agree to the terms and conditions</div>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span class="btn-text">Create Patient Account</span>
                    <div class="loading-spinner" id="submitSpinner"></div>
                </button>
            </form>

            <div class="divider">
                <span>Or sign up with</span>
            </div>

            <button class="btn btn-google" onclick="signInWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>

            <div class="login-link">
                Already have an account? <a href="{{ url_for('login') }}">Sign in here</a>
            </div>

            <div class="back-home">
                <a href="{{ url_for('index') }}">
                    <span>←</span>
                    Back to Home
                </a>
            </div>
        </div>
    </div>

<script>
    // Global variables
    let isUsernameAvailable = true;
    let isPasswordStrong = false;
    let isPasswordMatching = false;
    let isFormValid = false;

    // DOM Elements
    const signupForm = document.getElementById('signupForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitSpinner = document.getElementById('submitSpinner');
    const btnText = document.querySelector('.btn-text');

    // Toggle password visibility
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const toggleButton = field.parentNode.querySelector('.password-toggle');
        
        if (field.type === 'password') {
            field.type = 'text';
            toggleButton.textContent = '🙈';
        } else {
            field.type = 'password';
            toggleButton.textContent = '👁️';
        }
    }

    // Password strength checker - FIXED
    function checkPasswordStrength(password) {
        const strengthElement = document.getElementById('password-strength');
        const requirements = {
            length: document.getElementById('reqLength'),
            uppercase: document.getElementById('reqUppercase'),
            lowercase: document.getElementById('reqLowercase'),
            number: document.getElementById('reqNumber'),
            special: document.getElementById('reqSpecial')
        };

        let strength = 0;

        // Check password length
        const hasLength = password.length >= 8;
        if (hasLength) {
            strength++;
            requirements.length.classList.add('met');
            requirements.length.classList.remove('unmet');
            requirements.length.querySelector('.requirement-icon').textContent = '✓';
        } else {
            requirements.length.classList.remove('met');
            requirements.length.classList.add('unmet');
            requirements.length.querySelector('.requirement-icon').textContent = '○';
        }

        // Check for uppercase letters
        const hasUppercase = /[A-Z]/.test(password);
        if (hasUppercase) {
            strength++;
            requirements.uppercase.classList.add('met');
            requirements.uppercase.classList.remove('unmet');
            requirements.uppercase.querySelector('.requirement-icon').textContent = '✓';
        } else {
            requirements.uppercase.classList.remove('met');
            requirements.uppercase.classList.add('unmet');
            requirements.uppercase.querySelector('.requirement-icon').textContent = '○';
        }

        // Check for lowercase letters
        const hasLowercase = /[a-z]/.test(password);
        if (hasLowercase) {
            strength++;
            requirements.lowercase.classList.add('met');
            requirements.lowercase.classList.remove('unmet');
            requirements.lowercase.querySelector('.requirement-icon').textContent = '✓';
        } else {
            requirements.lowercase.classList.remove('met');
            requirements.lowercase.classList.add('unmet');
            requirements.lowercase.querySelector('.requirement-icon').textContent = '○';
        }

        // Check for numbers
        const hasNumber = /[0-9]/.test(password);
        if (hasNumber) {
            strength++;
            requirements.number.classList.add('met');
            requirements.number.classList.remove('unmet');
            requirements.number.querySelector('.requirement-icon').textContent = '✓';
        } else {
            requirements.number.classList.remove('met');
            requirements.number.classList.add('unmet');
            requirements.number.querySelector('.requirement-icon').textContent = '○';
        }

        // Check for special characters
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
        if (hasSpecial) {
            strength++;
            requirements.special.classList.add('met');
            requirements.special.classList.remove('unmet');
            requirements.special.querySelector('.requirement-icon').textContent = '✓';
        } else {
            requirements.special.classList.remove('met');
            requirements.special.classList.add('unmet');
            requirements.special.querySelector('.requirement-icon').textContent = '○';
        }

        // Update strength indicator and set isPasswordStrong
        if (password.length === 0) {
            strengthElement.textContent = '';
            strengthElement.className = 'password-strength';
            isPasswordStrong = false;
        } else {
            switch(strength) {
                case 0:
                case 1:
                case 2:
                    strengthElement.textContent = 'Weak password';
                    strengthElement.className = 'password-strength strength-weak';
                    isPasswordStrong = false;
                    break;
                case 3:
                case 4:
                    strengthElement.textContent = 'Medium strength password';
                    strengthElement.className = 'password-strength strength-medium';
                    isPasswordStrong = (hasLength && hasUppercase && hasLowercase && hasNumber);
                    break;
                case 5:
                    strengthElement.textContent = 'Strong password';
                    strengthElement.className = 'password-strength strength-strong';
                    isPasswordStrong = true;
                    break;
            }
        }

        // Update password field validation
        validateField('password');
        // Also check password match when password changes
        checkPasswordMatch();
        
        validateForm();
    }

    // Check password match - FIXED
    function checkPasswordMatch() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const errorElement = document.getElementById('confirmPasswordError');

        if (confirmPassword.length === 0) {
            clearFieldError('confirm_password');
            isPasswordMatching = false;
        } else if (password !== confirmPassword) {
            showFieldError('confirm_password', 'Passwords do not match');
            isPasswordMatching = false;
        } else {
            clearFieldError('confirm_password');
            isPasswordMatching = true;
        }

        validateForm();
    }

    // Check username availability
    async function checkUsernameAvailability(username) {
        const availabilityElement = document.getElementById('usernameAvailability');
        const errorElement = document.getElementById('usernameError');

        if (username.length < 3) {
            availabilityElement.style.display = 'none';
            errorElement.classList.remove('show');
            isUsernameAvailable = true;
            validateForm();
            return;
        }

        if (username.length > 80) {
            showFieldError('username', 'Username must be less than 80 characters');
            isUsernameAvailable = false;
            validateForm();
            return;
        }

        // Simulate API call to check username availability
        setTimeout(() => {
            // Simulate random availability for demo
            const isAvailable = Math.random() > 0.3; // 70% chance of availability
            
            if (isAvailable) {
                availabilityElement.style.display = 'block';
                errorElement.classList.remove('show');
                clearFieldError('username');
                isUsernameAvailable = true;
            } else {
                availabilityElement.style.display = 'none';
                showFieldError('username', 'Username is already taken');
                isUsernameAvailable = false;
            }
            
            validateForm();
        }, 500);
    }

    // Validate email format
    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Validate phone number (Kenyan format) - FIXED
    function validatePhone(phone) {
        // Remove spaces and dashes
        const cleanPhone = phone.replace(/[\s\-]/g, '');
        // Kenyan phone number regex: +254... or 0...
        const phoneRegex = /^(\+?254|0)[17]\d{8}$/;
        return phoneRegex.test(cleanPhone);
    }

    // Show field error
    function showFieldError(fieldName, message) {
        const field = document.getElementById(fieldName);
        const errorElement = document.getElementById(fieldName + 'Error');
        
        if (field && errorElement) {
            field.classList.add('error');
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }
    }

    // Clear field error
    function clearFieldError(fieldName) {
        const field = document.getElementById(fieldName);
        const errorElement = document.getElementById(fieldName + 'Error');
        
        if (field && errorElement) {
            field.classList.remove('error');
            errorElement.classList.remove('show');
        }
    }

    // Validate individual field - FIXED
    function validateField(fieldName) {
        const field = document.getElementById(fieldName);
        if (!field) return true;

        const value = field.value.trim();

        switch(fieldName) {
            case 'first_name':
            case 'last_name':
                if (!value) {
                    showFieldError(fieldName, `Please enter your ${fieldName.replace('_', ' ')}`);
                    return false;
                }
                clearFieldError(fieldName);
                return true;

            case 'email':
                if (!value) {
                    showFieldError(fieldName, 'Please enter your email address');
                    return false;
                }
                if (!validateEmail(value)) {
                    showFieldError(fieldName, 'Please enter a valid email address');
                    return false;
                }
                clearFieldError(fieldName);
                return true;

            case 'phone':
                if (!value) {
                    showFieldError(fieldName, 'Please enter your phone number');
                    return false;
                }
                if (!validatePhone(value)) {
                    showFieldError(fieldName, 'Please enter a valid Kenyan phone number (e.g., +254712345678 or 0712345678)');
                    return false;
                }
                clearFieldError(fieldName);
                return true;

            case 'password':
                if (!value) {
                    showFieldError(fieldName, 'Please enter a password');
                    return false;
                }
                if (!isPasswordStrong) {
                    showFieldError(fieldName, 'Password does not meet strength requirements');
                    return false;
                }
                clearFieldError(fieldName);
                return true;

            case 'confirm_password':
                if (!value) {
                    showFieldError(fieldName, 'Please confirm your password');
                    return false;
                }
                if (!isPasswordMatching) {
                    showFieldError(fieldName, 'Passwords do not match');
                    return false;
                }
                clearFieldError(fieldName);
                return true;

            default:
                return true;
        }
    }

    // Validate entire form - FIXED
    function validateForm() {
        const requiredFields = [
            'first_name', 'last_name', 'email', 'phone', 'password', 'confirm_password'
        ];

        // Validate all required fields
        let allValid = true;
        requiredFields.forEach(field => {
            if (!validateField(field)) {
                allValid = false;
            }
        });

        // Check terms and conditions
        const termsCheckbox = document.getElementById('terms');
        const termsAccepted = termsCheckbox ? termsCheckbox.checked : false;
        if (!termsAccepted) {
            const termsError = document.getElementById('termsError');
            if (termsError) {
                termsError.classList.add('show');
            }
            allValid = false;
        } else {
            const termsError = document.getElementById('termsError');
            if (termsError) {
                termsError.classList.remove('show');
            }
        }

        // Check username availability if provided
        const usernameField = document.getElementById('username');
        const username = usernameField ? usernameField.value.trim() : '';
        if (username && !isUsernameAvailable) {
            allValid = false;
        }

        isFormValid = allValid;
        updateSubmitButton();
    }

    // Update submit button state - FIXED
    function updateSubmitButton() {
        if (submitBtn) {
            submitBtn.disabled = !isFormValid;
        }
    }

    // Form submission
    signupForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!isFormValid) {
            validateForm();
            return;
        }

        // Show loading state
        submitBtn.disabled = true;
        btnText.textContent = 'Creating Account...';
        submitSpinner.classList.add('show');

        try {
            // Prepare form data
            const formData = new FormData(signupForm);

            // Submit the form
            const response = await fetch(signupForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });

            if (response.redirected) {
                // If redirected, follow the redirect
                window.location.href = response.url;
            } else {
                const result = await response.json();
                if (result.success) {
                    // Success case - redirect to login or show success message
                    window.location.href = "{{ url_for('login') }}";
                } else {
                    // Show error message
                    alert(result.message || 'An error occurred during signup');
                    // Reset loading state
                    resetSubmitButton();
                }
            }
        } catch (error) {
            console.error('Signup error:', error);
            alert('An error occurred. Please try again.');
            resetSubmitButton();
        }
    });

    // Reset submit button state
    function resetSubmitButton() {
        submitBtn.disabled = false;
        btnText.textContent = 'Create Patient Account';
        submitSpinner.classList.remove('show');
    }

    // Get CSRF token
    function getCSRFToken() {
        return document.querySelector('input[name="csrf_token"]')?.value || '';
    }

    // Real-time validation - FIXED
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize all form fields with event listeners
        const formFields = ['first_name', 'last_name', 'email', 'username', 'phone', 'password', 'confirm_password'];
        
        formFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (field) {
                field.addEventListener('blur', function() {
                    validateField(this.id);
                });

                field.addEventListener('input', function() {
                    // Clear error when user starts typing
                    if (this.classList.contains('error')) {
                        clearFieldError(this.id);
                    }
                    // Validate in real-time for specific fields
                    if (this.id === 'password') {
                        checkPasswordStrength(this.value);
                    } else if (this.id === 'confirm_password') {
                        checkPasswordMatch();
                    } else if (this.id === 'username') {
                        checkUsernameAvailability(this.value);
                    } else {
                        validateField(this.id);
                    }
                });
            }
        });

        // Terms checkbox validation
        const termsCheckbox = document.getElementById('terms');
        if (termsCheckbox) {
            termsCheckbox.addEventListener('change', validateForm);
        }

        // Auto-hide flash messages
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(message => {
            setTimeout(() => {
                message.style.transition = 'all 0.3s ease';
                message.style.opacity = '0';
                message.style.height = '0';
                message.style.margin = '0';
                message.style.padding = '0';
                setTimeout(() => message.remove(), 300);
            }, 5000);
        });

        // Set maximum date for date of birth (18 years ago)
        const dobField = document.getElementById('date_of_birth');
        if (dobField) {
            const maxDate = new Date();
            maxDate.setFullYear(maxDate.getFullYear() - 18);
            dobField.max = maxDate.toISOString().split('T')[0];
        }

        // Initialize form validation and disable submit button
        validateForm();
        updateSubmitButton();
    });

    // Google Sign-In Functionality
    function signInWithGoogle() {
        window.location.href = "{{ url_for('google_login') }}";
    }
</script>
</body>
</html>